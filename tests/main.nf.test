nextflow_pipeline {

    name "Full Pipeline NF-Tests for LegioVUE"
    script "main.nf"

    //--- Test 1
    test("Conflicting Input Data Sources Specified") {
        tag "fail"

        when {
            params {
                input = "$baseDir/tests/test_data/input_none.csv"
                fastq_dir = "$baseDir/tests/test_data/"
                outdir = "results"
            }
        }
        then {
            // Status
            assert workflow.failed

            // Message
            assert workflow.stdout.contains("ERROR ~ Please provide input data with either: '--input input.csv' or '--fastq_dir <PATH/TO/PAIRED_FASTQS>' but not both")
        }
    }

    //--- Test 2
    test("No Input Data Sources Specified") {
        tag "fail"

        when {
            params {
                outdir = "results"
            }
        }
        then {
            // Status
            assert workflow.failed

            // Message
            assert workflow.stdout.contains("ERROR ~ Please provide input data with either: '--input input.csv' or '--fastq_dir <PATH/TO/PAIRED_FASTQS>'")
        }
    }

    //--- Test 3
    test("Missing Input Fastq Test") {
        tag "fail"

        when {
            params {
                input = "$baseDir/tests/test_data/input.csv"
                outdir = "results"
                min_reads = 100
            }
        }
        then {
            // Status
            assert workflow.failed

            // Message
            assert workflow.stdout.contains("ERROR ~ Validation of pipeline parameters failed!")
        }
    }

    //--- Test 4
    test("Stub Run Test") {
        tag "success"
        options "-stub-run"

        when {
            params {
                fastq_dir = "$baseDir/tests/test_data/"
                outdir = "results"
                min_reads = 0
                max_memory = "8.GB"
                max_cpus = 2
                max_time = "1.h"
            }
        }
        then {
            // Status
            assert workflow.success
            assert workflow.trace.failed().size() == 0

            // Channels and Files Exist
            //  Stub run so they are all blank so just make sure all output steps exist
            assert path("$launchDir/results").exists()
            assert path("$launchDir/results/overall.qc.csv").exists()

            assert path("$launchDir/results/chewbbaca/allele_calls").exists()
            assert path("$launchDir/results/chewbbaca/allele_calls/cgMLST").exists()

            assert path("$launchDir/results/el_gato/el_gato_st.tsv").exists()
            assert path("$launchDir/results/el_gato/el_gato_report.pdf").exists()
            assert path("$launchDir/results/el_gato/allele_stats").exists()
            assert path("$launchDir/results/el_gato/assembly").exists()
            assert path("$launchDir/results/el_gato/plots").exists()
            assert path("$launchDir/results/el_gato/reads").exists()

            assert path("$launchDir/results/pipeline_info").exists()
            assert path("$launchDir/results/pipeline_info/software_versions.yml").exists()
            assert path("$launchDir/results/pipeline_info/manifest.json").exists()

            assert path("$launchDir/results/fastqc").exists()
            assert path("$launchDir/results/kraken_bracken").exists()
            assert path("$launchDir/results/quast").exists()
            assert path("$launchDir/results/spades").exists()
            assert path("$launchDir/results/trimmomatic").exists()
        }
    }
}
